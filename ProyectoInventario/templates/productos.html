{% extends "base.html" %}

{% block title %}Productos{% endblock %}

{% block header %}Gestión de Productos{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <!-- 1. Botón para Agregar -->
    <div class="mb-4">
        <button onclick="abrirModalProducto(null)" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Agregar Producto
        </button>
    </div>
    
    <!-- 2. Tabla de Productos -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">ID</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Nombre</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Precio</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Cantidad</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Departamento</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Almacén</th>
                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                        <span class="sr-only">Acciones</span>
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white" id="tabla-productos">
                <!-- Los datos se cargarán aquí por JavaScript -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

<!-- Bloque de Modales -->
{% block modals %}
<!-- Modal para Agregar/Modificar Producto -->
<div id="modal-producto" class="modal hidden fixed inset-0 z-10 w-screen h-screen bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0" onclick="cerrarModalProducto(event)">
    <div class="modal-content w-full max-w-2xl bg-white rounded-lg shadow-xl p-6 transform scale-95" onclick="event.stopPropagation()">
        <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-producto-titulo"></h3>
        <form id="form-producto" class="mt-4 space-y-4">
            <input type="hidden" id="producto-id" name="id">
            
            <div class="grid grid-cols-1 gap-y-4 sm:grid-cols-2 sm:gap-x-6">
                <div>
                    <label for="producto-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="producto-nombre" name="nombre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="producto-departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <input type="text" id="producto-departamento" name="departamento" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="producto-precio" class="block text-sm font-medium text-gray-700">Precio</label>
                    <input type="number" id="producto-precio" name="precio" step="0.01" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="producto-cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="producto-cantidad" name="cantidad" min="0" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div class="sm:col-span-2">
                    <label for="producto-almacen" class="block text-sm font-medium text-gray-700">Almacén</label>
                    <select id="producto-almacen" name="almacen" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <!-- Opciones de almacén se cargarán aquí -->
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="cerrarModalProducto(null, true)" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                    Confirmar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar -->
<div id="modal-eliminar-producto" class="modal hidden fixed inset-0 z-10 w-screen h-screen bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0" onclick="cerrarModalEliminarProducto(event)">
    <div class="modal-content w-full max-w-md bg-white rounded-lg shadow-xl p-6 transform scale-95" onclick="event.stopPropagation()">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Eliminar Producto</h3>
        <p class="mt-2 text-sm text-gray-600">
            ¿Realmente se quiere eliminar la selección? Esta acción no se puede deshacer.
        </p>
        <input type="hidden" id="producto-id-eliminar">
        
        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" onclick="cerrarModalEliminarProducto(null, true)" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                No
            </button>
            <button type="button" onclick="confirmarEliminarProducto()" class="rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                Sí, eliminar
            </button>
        </div>
    </div>
</div>
{% endblock %}

<!-- Bloque de Scripts -->
{% block scripts %}
<script>
    // --- Variables Globales ---
    const modalProducto = document.getElementById('modal-producto');
    const modalEliminarProducto = document.getElementById('modal-eliminar-producto');
    const formProducto = document.getElementById('form-producto');
    const tablaProductos = document.getElementById('tabla-productos');
    const selectAlmacen = document.getElementById('producto-almacen');
    let almacenesMap = new Map();

    // --- Carga Inicial ---
    document.addEventListener('DOMContentLoaded', () => {
        cargarAlmacenes(); 
        cargarProductos();
    });

    // --- Carga de Datos ---
    async function cargarAlmacenes() {
        try {
            const response = await fetch('/api/almacenes');
            const almacenes = await response.json();
            
            selectAlmacen.innerHTML = '<option value="">Seleccione un almacén</option>';
            almacenesMap.clear();

            almacenes.forEach(almacen => {
                const option = document.createElement('option');
                option.value = almacen.id;
                option.textContent = almacen.nombre;
                selectAlmacen.appendChild(option);
                almacenesMap.set(almacen.id, almacen.nombre);
            });
        } catch (error) {
            console.error('Error al cargar almacenes:', error);
        }
    }

    async function cargarProductos() {
        try {
            const response = await fetch('/api/productos');
            const productos = await response.json();
            
            tablaProductos.innerHTML = ''; 
            if (productos.length === 0) {
                tablaProductos.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay productos registrados.</td></tr>';
                return;
            }
            
            productos.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">${producto.id}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${producto.nombre}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">$${producto.precio.toFixed(2)}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${producto.cantidad}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${producto.departamento}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${almacenesMap.get(producto.almacen) || 'N/A'}</td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                        <button onclick='abrirModalProducto(${JSON.stringify(producto)})' class="text-indigo-600 hover:text-indigo-900 mr-3">
                            Modificar<span class="sr-only">, ${producto.nombre}</span>
                        </button>
                        <button onclick="abrirModalEliminarProducto(${producto.id})" class="text-red-600 hover:text-red-900">
                            Eliminar<span class="sr-only">, ${producto.nombre}</span>
                        </button>
                    </td>
                `;
                tablaProductos.appendChild(tr);
            });
        } catch (error) {
            console.error('Error al cargar productos:', error);
        }
    }

    // --- Lógica del Modal (Producto) ---
    function abrirModalProducto(producto) {
        formProducto.reset(); 
        const titulo = document.getElementById('modal-producto-titulo');
        
        if (producto) {
            titulo.textContent = 'Modificar Producto';
            document.getElementById('producto-id').value = producto.id;
            document.getElementById('producto-nombre').value = producto.nombre;
            document.getElementById('producto-precio').value = producto.precio;
            document.getElementById('producto-cantidad').value = producto.cantidad;
            document.getElementById('producto-departamento').value = producto.departamento;
            document.getElementById('producto-almacen').value = producto.almacen;
        } else {
            titulo.textContent = 'Agregar Producto';
            document.getElementById('producto-id').value = '';
        }
        
        modalProducto.classList.remove('hidden');
        setTimeout(() => modalProducto.classList.remove('opacity-0'), 10);
        setTimeout(() => modalProducto.querySelector('.modal-content').classList.remove('scale-95'), 10);
    }

    function cerrarModalProducto(event, force = false) {
        if (force || event.target === modalProducto) {
            modalProducto.classList.add('opacity-0');
            modalProducto.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modalProducto.classList.add('hidden'), 250);
        }
    }

    // --- Lógica del Modal (Eliminar) ---
    function abrirModalEliminarProducto(id) {
        document.getElementById('producto-id-eliminar').value = id;
        modalEliminarProducto.classList.remove('hidden');
        setTimeout(() => modalEliminarProducto.classList.remove('opacity-0'), 10);
        setTimeout(() => modalEliminarProducto.querySelector('.modal-content').classList.remove('scale-95'), 10);
    }
    
    function cerrarModalEliminarProducto(event, force = false) {
        if (force || event.target === modalEliminarProducto) {
            modalEliminarProducto.classList.add('opacity-0');
            modalEliminarProducto.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modalEliminarProducto.classList.add('hidden'), 250);
        }
    }

    // --- Acciones CRUD (Fetch API) ---
    
    formProducto.addEventListener('submit', async (event) => {
        event.preventDefault(); 
        
        const id = document.getElementById('producto-id').value;
        const formData = new FormData(formProducto);
        const data = Object.fromEntries(formData.entries());
        
        const url = id ? `/api/productos/${id}` : '/api/productos';
        const method = id ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                cerrarModalProducto(null, true);
                cargarProductos(); 
            } else {
                console.error('Error al guardar el producto');
            }
        } catch (error) {
            console.error('Error de red:', error);
        }
    });
    
    async function confirmarEliminarProducto() {
        const id = document.getElementById('producto-id-eliminar').value;
        try {
            const response = await fetch(`/api/productos/${id}`, { method: 'DELETE' });
            if (response.ok) {
                cerrarModalEliminarProducto(null, true);
                cargarProductos(); 
            } else {
                console.error('Error al eliminar el producto');
            }
        } catch (error) {
            console.error('Error de red:', error);
        }
    }
</script>
{% endblock %}